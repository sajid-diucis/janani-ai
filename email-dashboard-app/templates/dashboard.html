<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediMail - Clinical Dashboard</title>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f3f4f6;
            --sidebar-w: 250px;
            --list-w: 350px;
            --border: #e5e7eb;
        }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; height: 100vh; display: flex; overflow: hidden; background: var(--bg); }
        
        /* Sidebar */
        .sidebar { width: var(--sidebar-w); background: #1e293b; color: #fff; display: flex; flex-direction: column; padding: 20px; }
        .logo { font-size: 1.5rem; font-weight: bold; margin-bottom: 40px; color: #60a5fa; display: flex; align-items: center; gap: 10px; }
        .nav-item { padding: 12px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; margin-bottom: 5px; color: #cbd5e1; }
        .nav-item.active { background: #334155; color: #fff; }
        .nav-item:hover { background: #334155; }
        .badge { background: #ef4444; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; margin-left: auto; }

        /* Email List */
        .email-list { width: var(--list-w); background: #fff; border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .list-header { padding: 20px; border-bottom: 1px solid var(--border); font-weight: bold; font-size: 1.1rem; }
        .email-item { padding: 15px 20px; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.2s; }
        .email-item:hover { background: #f8fafc; }
        .email-item.unread { background: #eff6ff; border-left: 4px solid var(--primary); }
        .email-item.active { background: #e0e7ff; }
        .sender { font-weight: 600; font-size: 0.95rem; margin-bottom: 4px; display: flex; justify-content: space-between; }
        .time { font-weight: 400; color: #64748b; font-size: 0.8rem; }
        .subject { font-size: 0.9rem; color: #334155; margin-bottom: 4px; font-weight: 500; }
        .snippet { font-size: 0.8rem; color: #64748b; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Reading Pane */
        .reading-pane { flex: 1; background: #fff; display: flex; flex-direction: column; overflow: hidden; }
        .email-header { padding: 30px; border-bottom: 1px solid var(--border); background: #fff; }
        .email-subject { font-size: 1.5rem; font-weight: 600; margin-bottom: 15px; color: #1e293b; }
        .email-meta { display: flex; align-items: center; gap: 15px; }
        .avatar { width: 40px; height: 40px; background: #e2e8f0; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #475569; }
        .meta-info div:first-child { font-weight: 600; color: #1e293b; }
        .meta-info div:last-child { font-size: 0.85rem; color: #64748b; }
        
        .email-body { flex: 1; padding: 40px; overflow-y: auto; color: #334155; line-height: 1.6; font-size: 1rem; }
        
        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #94a3b8; }
        .empty-state svg { width: 64px; height: 64px; margin-bottom: 20px; opacity: 0.5; }

        /* Priority Tags */
        .tag { padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; }
        .tag.critical { background: #fee2e2; color: #dc2626; }
        .tag.normal { background: #e0f2fe; color: #0284c7; }

    </style>
</head>
<body>
    <div class="sidebar">
        <div class="logo">üè• MediMail</div>
        <div class="nav-item active">
            <span>üì• Inbox</span>
            <span class="badge" id="unread-count" style="display:none">0</span>
        </div>
        <div class="nav-item"><span>‚≠ê Starred</span></div>
        <div class="nav-item"><span>üì§ Sent</span></div>
        <div class="nav-item"><span>üóëÔ∏è Trash</span></div>
    </div>

    <div class="email-list" id="email-list-container">
        <div class="list-header">Inbox</div>
        <div id="email-items">
            <!-- Items injected here -->
        </div>
    </div>

    <div class="reading-pane" id="reading-pane">
        <div class="empty-state">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
            <p>Select an email to read</p>
        </div>
    </div>

    <script>
        const JANANI_API_URL = "{{ janani_service_url }}";
        let emails = [];
        let selectedEmailId = null;

        async function fetchEmails() {
            try {
                const res = await fetch('/api/inbox');
                const newEmails = await res.json();
                
                // Simple check if list changed
                if (JSON.stringify(newEmails) !== JSON.stringify(emails)) {
                    emails = newEmails;
                    renderList();
                    updateBadge();
                }
            } catch (e) {
                console.error("Polling error", e);
            }
        }

        function renderList() {
            const container = document.getElementById('email-items');
            container.innerHTML = emails.map(email => `
                <div class="email-item ${email.is_read ? '' : 'unread'} ${email.id === selectedEmailId ? 'active' : ''}" 
                     onclick="selectEmail('${email.id}')">
                    <div class="sender">
                        ${email.sender}
                        <span class="time">${email.timestamp}</span>
                    </div>
                    <div class="subject">
                        ${email.subject}
                        ${email.priority === 'high' ? '<span class="tag critical">URGENT</span>' : ''}
                    </div>
                    <div class="snippet">${stripHtml(email.body)}</div>
                </div>
            `).join('');
        }

        function updateBadge() {
            const count = emails.filter(e => !e.is_read).length;
            const badge = document.getElementById('unread-count');
            badge.innerText = count;
            badge.style.display = count > 0 ? 'inline-block' : 'none';
        }

        function stripHtml(html) {
            let tmp = document.createElement("DIV");
            tmp.innerHTML = html;
            return tmp.textContent || tmp.innerText || "";
        }

        async function selectEmail(id) {
            selectedEmailId = id;
            const email = emails.find(e => e.id === id);
            if (!email) return;

            // Render Body
            const pane = document.getElementById('reading-pane');
            pane.innerHTML = `
                <div class="email-header">
                    <div class="email-subject">
                        ${email.priority === 'high' ? '<span class="tag critical" style="font-size:1rem; vertical-align:middle; margin-right:10px;">URGENT</span>' : ''}
                        ${email.subject}
                    </div>
                    <div class="email-meta">
                        <div class="avatar">${email.sender[0]}</div>
                        <div class="meta-info">
                            <div>${email.sender}</div>
                            <div>To: Dr. Smith &lt;dr.smith@medimail.com&gt;</div>
                        </div>
                        <div style="margin-left:auto; color:#64748b;">${email.timestamp}</div>
                    </div>
                </div>
                <div class="email-body">
                    ${email.body}
                </div>
            `;

            // Mark Read locally and API
            if (!email.is_read) {
                email.is_read = true;
                renderList();
                updateBadge();
                await fetch(`/api/inbox/${id}/read`, { method: 'POST' });
            }
            renderList(); // Re-render to update active state
        }

        // --- NEW: Doctor Action Handler ---
        async function sendDoctorAction(btn, userId, actionType, note) {
            // Visual feedback
            const originalText = btn.innerText;
            btn.innerText = "‚è≥ Sending...";
            btn.disabled = true;

            try {
                const payload = {
                    doctor_id: "dr_smith",
                    action_type: actionType,
                    note: note,
                    timestamp: new Date().toISOString()
                };

                // Directly call Janani API (CORS enabled)
                const res = await fetch(`${JANANI_API_URL}/api/medical-report/${userId}/doctor-action`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) throw new Error("Failed to update Janani");

                // Success Feedback
                btn.innerText = "‚úì Sent";
                btn.style.background = "#9ca3af"; // Gray out
                
                // Show notification in dashboard
                const notification = document.createElement("div");
                notification.style.cssText = "position:fixed; bottom:20px; right:20px; background:#10b981; color:white; padding:15px; border-radius:5px; box-shadow:0 4px 6px rgba(0,0,0,0.1); animation: fadein 0.5s;";
                notification.innerText = `Action Sent: ${note}`;
                document.body.appendChild(notification);
                setTimeout(() => notification.remove(), 3000);

            } catch (e) {
                console.error(e);
                btn.innerText = "‚ùå Error";
                btn.disabled = false;
                alert("Failed to sync with Janani AI: " + e.message);
            }
        }
        // ----------------------------------

        // Poll every 2 seconds
        setInterval(fetchEmails, 2000);
        fetchEmails(); // Initial fetch
    </script>
</body>
</html>
