<!DOCTYPE html>
<html lang="bn">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üè• AR ‡¶ú‡¶∞‡ßÅ‡¶∞‡¶ø ‡¶∏‡¶π‡¶æ‡¶Ø‡¶º‡¶§‡¶æ - Janani AI</title>

    <!-- PWA Support -->
    <meta name="theme-color" content="#D32F2F">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="/static/manifest.json">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0a0a;
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Status Bar */
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: rgba(0, 0, 0, 0.8);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            padding: 5px 10px;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.1);
        }

        .status-item.online {
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
        }

        .status-item.offline {
            background: rgba(244, 67, 54, 0.2);
            color: #F44336;
        }

        .status-item.processing {
            background: rgba(33, 150, 243, 0.2);
            color: #2196F3;
        }

        /* Main Container */
        .ar-container {
            position: relative;
            width: 100%;
            height: 100vh;
            overflow: hidden;
        }

        /* Video Feed */
        #ar-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
            /* Mirror for selfie view */
        }

        /* AR Canvas Overlay */
        #ar-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            transform: scaleX(-1);
        }

        /* Scenario Selector */
        .scenario-selector {
            position: fixed;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            z-index: 100;
            padding: 10px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 25px;
            backdrop-filter: blur(10px);
        }

        .scenario-btn {
            padding: 10px 15px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
        }

        .scenario-btn:hover,
        .scenario-btn.active {
            background: linear-gradient(135deg, #E91E63, #9C27B0);
            border-color: #E91E63;
            transform: scale(1.05);
        }

        .scenario-btn .icon {
            font-size: 20px;
        }

        .scenario-btn .label {
            font-size: 10px;
        }

        /* Instructions Panel */
        .instructions-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.95), rgba(0, 0, 0, 0.7));
            padding: 20px;
            max-height: 40vh;
            overflow-y: auto;
            z-index: 100;
        }

        .instruction-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .instruction-header .icon {
            font-size: 40px;
        }

        .instruction-header .title {
            font-size: 20px;
            font-weight: bold;
        }

        .instruction-header .subtitle {
            font-size: 12px;
            opacity: 0.7;
        }

        .instruction-step {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            margin-bottom: 10px;
            border-left: 4px solid #4CAF50;
        }

        .instruction-step.critical {
            border-left-color: #F44336;
            background: rgba(244, 67, 54, 0.1);
        }

        .instruction-step.warning {
            border-left-color: #FF9800;
            background: rgba(255, 152, 0, 0.1);
        }

        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: linear-gradient(135deg, #E91E63, #9C27B0);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .step-content {
            flex: 1;
        }

        .step-bn {
            font-size: 15px;
            margin-bottom: 3px;
        }

        .step-en {
            font-size: 11px;
            opacity: 0.6;
        }

        .speak-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            cursor: pointer;
        }

        /* Emergency Call Button */
        .emergency-call {
            position: fixed;
            bottom: 45vh;
            right: 20px;
            z-index: 200;
        }

        .emergency-call a {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: linear-gradient(135deg, #F44336, #D32F2F);
            color: white;
            text-decoration: none;
            font-size: 30px;
            box-shadow: 0 5px 25px rgba(244, 67, 54, 0.5);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.7);
            }

            70% {
                box-shadow: 0 0 0 20px rgba(244, 67, 54, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(244, 67, 54, 0);
            }
        }

        /* Timer Overlay */
        .timer-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            z-index: 300;
            display: none;
        }

        .timer-display {
            font-size: 80px;
            font-weight: bold;
            color: #4CAF50;
            text-shadow: 0 0 30px rgba(76, 175, 80, 0.5);
        }

        /* Metronome for CPR */
        .metronome {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 250;
            display: none;
        }

        .metronome-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: rgba(244, 67, 54, 0.3);
            border: 4px solid #F44336;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
        }

        .metronome-circle.beat {
            animation: beat 0.5s ease;
        }

        @keyframes beat {
            0% {
                transform: scale(1);
                background: rgba(244, 67, 54, 0.3);
            }

            50% {
                transform: scale(1.2);
                background: rgba(244, 67, 54, 0.8);
            }

            100% {
                transform: scale(1);
                background: rgba(244, 67, 54, 0.3);
            }
        }

        /* AR Visual Guides */
        .ar-guide-text {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 14px;
            pointer-events: none;
            z-index: 50;
        }

        /* Loading State */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 500;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: #E91E63;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            margin-top: 20px;
            font-size: 16px;
        }

        /* Disclaimer */
        .disclaimer {
            position: fixed;
            top: 120px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid #FFC107;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 11px;
            color: #FFC107;
            z-index: 100;
            text-align: center;
            max-width: 90%;
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <p class="loading-text">üè• AR ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>
        <p style="font-size: 12px; opacity: 0.6; margin-top: 10px;">Loading MediaPipe WASM...</p>
    </div>

    <!-- Status Bar -->
    <div class="status-bar">
        <div class="status-item" id="connectionStatus">
            <span>üì∂</span>
            <span id="connectionText">‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶®</span>
        </div>
        <div class="status-item" id="fpsStatus">
            <span>‚ö°</span>
            <span id="fpsText">-- FPS</span>
        </div>
        <div class="status-item" id="batteryStatus">
            <span>üîã</span>
            <span id="batteryText">--%</span>
        </div>
    </div>

    <!-- Scenario Selector -->
    <div class="scenario-selector">
        <div class="scenario-btn active" id="btn-labor" onclick="selectScenario('labor')">
            <span class="icon">üë∂</span>
            <span class="label">‡¶™‡ßç‡¶∞‡¶∏‡¶¨</span>
        </div>
        <div class="scenario-btn" id="btn-bleeding" onclick="selectScenario('bleeding')">
            <span class="icon">ü©∏</span>
            <span class="label">‡¶∞‡¶ï‡ßç‡¶§‡¶™‡¶æ‡¶§</span>
        </div>
        <div class="scenario-btn" id="btn-seizure" onclick="selectScenario('seizure')">
            <span class="icon">‚ö°</span>
            <span class="label">‡¶ñ‡¶ø‡¶Å‡¶ö‡ßÅ‡¶®‡¶ø</span>
        </div>
        <div class="scenario-btn" id="btn-newborn" onclick="selectScenario('newborn')">
            <span class="icon">üë∂üíö</span>
            <span class="label">‡¶®‡¶¨‡¶ú‡¶æ‡¶§‡¶ï</span>
        </div>
        <div class="scenario-btn" id="btn-ai" onclick="openAIModal()">
            <span class="icon">ü§ñ</span>
            <span class="label">Ask AI</span>
        </div>
        <div class="scenario-btn" id="btn-clinical" onclick="openClinicalMode()" style="border-color: #00BCD4;">
            <span class="icon">üë®‚Äç‚öïÔ∏è</span>
            <span class="label">Clinician</span>
        </div>
    </div>

    <!-- AI Input Modal -->
    <div id="aiModal"
        style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 2000; align-items: center; justify-content: center; flex-direction: column;">
        <div
            style="background: #1a1a1a; padding: 25px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; border: 1px solid #333;">
            <div style="font-size: 40px; margin-bottom: 20px;">ü§ñ</div>
            <h2 style="color: white; margin-bottom: 15px;">‡¶ï‡¶ø ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá?</h2>
            <p style="color: #ccc; font-size: 14px; margin-bottom: 20px;">‡¶Ø‡ßá‡¶ï‡ßã‡¶®‡ßã ‡¶ú‡¶∞‡ßÅ‡¶∞‡¶ø ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶∞ ‡¶ï‡¶•‡¶æ ‡¶¨‡¶≤‡ßÅ‡¶® ‡¶¨‡¶æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®</p>

            <input type="text" id="aiInput" placeholder="‡¶â‡¶¶‡¶æ‡¶π‡¶∞‡¶£: ‡¶¨‡¶æ‡¶ö‡ßç‡¶ö‡¶æ ‡¶â‡¶≤‡ßç‡¶ü‡ßá ‡¶Ü‡¶õ‡ßá..."
                style="width: 100%; padding: 15px; border-radius: 10px; border: none; background: #333; color: white; margin-bottom: 20px; font-size: 16px;">

            <div style="margin-bottom: 20px;">
                <button onclick="startServerVoiceInput()" id="micBtn"
                    style="width: 70px; height: 70px; border-radius: 50%; background: #E91E63; border: none; color: white; font-size: 30px; cursor: pointer; box-shadow: 0 4px 15px rgba(233, 30, 99, 0.4);">
                    üé§
                </button>
                <p style="margin-top: 10px; color: #aaa; font-size: 12px;">‡¶¨‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶™ ‡¶¶‡¶ø‡¶®</p>
            </div>

            <div style="display: flex; gap: 10px; justify-content: center;">
                <button onclick="closeAIModal()"
                    style="padding: 10px 20px; border-radius: 10px; border: 1px solid #666; background: transparent; color: white; cursor: pointer;">‡¶¨‡¶®‡ßç‡¶ß
                    ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                <button onclick="submitAIQuery()"
                    style="padding: 10px 20px; border-radius: 10px; border: none; background: linear-gradient(135deg, #2196F3, #21CBF3); color: white; font-weight: bold; cursor: pointer;">‡¶™‡¶∞‡¶æ‡¶Æ‡¶∞‡ßç‡¶∂
                    ‡¶®‡¶ø‡¶®</button>
            </div>
        </div>
    </div>

    <!-- Clinical Mode Modal (Doctor View) -->
    <div id="clinicalModal"
        style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); z-index: 2000; overflow-y: auto; padding: 20px;">
        <div
            style="max-width: 600px; margin: 0 auto; background: #1a1a1a; border-radius: 15px; border: 1px solid #333; overflow: hidden;">

            <!-- Header -->
            <div style="background: linear-gradient(135deg, #0097A7, #006064); padding: 20px; text-align: center;">
                <div style="font-size: 30px; margin-bottom: 5px;">üë®‚Äç‚öïÔ∏è</div>
                <h2 style="color: white; margin: 0;">Clinical Insight Report</h2>
                <p style="color: rgba(255,255,255,0.8); font-size: 12px;">Senior Clinical Strategist Analysis</p>
            </div>

            <div id="clinicalContent" style="padding: 20px;">
                <!-- Loading State -->
                <div style="text-align: center; padding: 40px;">
                    <div class="loading-spinner" style="margin: 0 auto; border-top-color: #00BCD4;"></div>
                    <p style="margin-top: 15px; color: #aaa;">Synthesizing Patient History & Vitals...</p>
                </div>
            </div>

            <div style="padding: 15px; text-align: center; border-top: 1px solid #333;">
                <button onclick="document.getElementById('clinicalModal').style.display='none'"
                    style="padding: 10px 30px; border-radius: 20px; border: 1px solid #666; background: transparent; color: white; cursor: pointer;">
                    Close Report
                </button>
            </div>
        </div>
    </div>

    <!-- Disclaimer -->
    <div class="disclaimer">
        ‚ö†Ô∏è ‡¶è‡¶ü‡¶ø ‡¶è‡¶ï‡¶ü‡¶ø ‡¶è‡¶á‡¶° ‡¶ü‡ßÅ‡¶≤‡•§ ‡¶¨‡¶ø‡¶∂‡ßá‡¶∑‡¶ú‡ßç‡¶û ‡¶°‡¶æ‡¶ï‡ßç‡¶§‡¶æ‡¶∞‡ßá‡¶∞ ‡¶™‡¶∞‡¶æ‡¶Æ‡¶∞‡ßç‡¶∂ ‡¶®‡¶ø‡¶®‡•§
    </div>

    <!-- AR Container -->
    <div class="ar-container">
        <video id="ar-video" autoplay playsinline></video>
        <canvas id="ar-canvas"></canvas>

        <!-- AR Status Badge -->
        <div id="arStatusBadge" style="position: absolute; top: 80px; left: 50%; transform: translateX(-50%); 
            padding: 8px 20px; border-radius: 20px; background: rgba(255, 193, 7, 0.9); color: #333;
            font-size: 14px; font-weight: bold; z-index: 50; display: flex; align-items: center; gap: 8px;">
            <span id="arStatusIcon">üîç</span>
            <span id="arStatusText">‡¶∏‡ßç‡¶ï‡ßç‡¶Ø‡¶æ‡¶® ‡¶ï‡¶∞‡¶õ‡ßá...</span>
        </div>

        <!-- No Body Detected Warning -->
        <div id="noBodyWarning" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(244, 67, 54, 0.95); color: white; padding: 30px 40px; border-radius: 20px;
            text-align: center; z-index: 60; max-width: 80%;">
            <div style="font-size: 50px; margin-bottom: 15px;">üë§‚ùå</div>
            <h3 style="margin: 0 0 10px 0;">‡¶ï‡ßã‡¶®‡ßã ‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§‡¶ø ‡¶¶‡ßá‡¶ñ‡¶æ ‡¶Ø‡¶æ‡¶ö‡ßç‡¶õ‡ßá ‡¶®‡¶æ</h3>
            <p style="margin: 0; font-size: 14px; opacity: 0.9;">‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ‡¶Ø‡¶º ‡¶∂‡¶∞‡ßÄ‡¶∞ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶® (‡¶ï‡¶æ‡¶Å‡¶ß ‡¶•‡ßá‡¶ï‡ßá ‡¶ï‡ßã‡¶Æ‡¶∞)</p>
        </div>

        <!-- Position Guidance Overlay -->
        <div id="positionGuidance" style="display: none; position: absolute; bottom: 45%; left: 50%; transform: translateX(-50%);
            background: rgba(33, 150, 243, 0.95); color: white; padding: 15px 25px; border-radius: 15px;
            text-align: center; z-index: 55; min-width: 200px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <div id="guidanceArrow" style="font-size: 40px; margin-bottom: 8px;">‚¨áÔ∏è</div>
            <p id="guidanceText" style="margin: 0; font-size: 16px; font-weight: bold;">‡¶™‡ßá‡¶ü ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®</p>
            <p id="guidanceSubtext" style="margin: 5px 0 0 0; font-size: 12px; opacity: 0.8;">‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ ‡¶®‡¶ø‡¶ö‡ßá ‡¶ï‡¶∞‡ßÅ‡¶®</p>
        </div>
    </div>

    <!-- Emergency Call Button -->
    <div class="emergency-call">
        <a href="tel:999" title="‡ßØ‡ßØ‡ßØ ‡¶ï‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®">üìû</a>
    </div>

    <!-- Metronome for CPR -->
    <div class="metronome" id="metronome">
        <div class="metronome-circle" id="metronomeCircle">
            <span id="metronomeCount">‡¶ö‡¶æ‡¶™ ‡¶¶‡¶ø‡¶®</span>
        </div>
    </div>

    <!-- Timer Overlay -->
    <div class="timer-overlay" id="timerOverlay">
        <div class="timer-display" id="timerDisplay">30</div>
        <p style="margin-top: 15px;">‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶¨‡¶æ‡¶ï‡¶ø</p>
        <button onclick="stopTimer()"
            style="margin-top: 20px; padding: 12px 30px; border: none; border-radius: 25px; background: #F44336; color: white; cursor: pointer;">‡¶¨‡¶®‡ßç‡¶ß
            ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>

    <!-- Instructions Panel -->
    <div class="instructions-panel" id="instructionsPanel">
        <!-- Content loaded dynamically -->
    </div>

    <!-- MediaPipe & AR Scripts -->
    <script type="module">
        // ============ MediaPipe WASM Integration ============

        // Try to load from local first, fallback to CDN
        let PoseLandmarker, FilesetResolver, DrawingUtils;

        async function loadMediaPipe() {
            try {
                // Try loading from CDN (more reliable for demo)
                const vision = await import('https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/+esm');
                PoseLandmarker = vision.PoseLandmarker;
                FilesetResolver = vision.FilesetResolver;
                DrawingUtils = vision.DrawingUtils;
                console.log('‚úÖ MediaPipe loaded from CDN');
                return true;
            } catch (e) {
                console.error('‚ùå Failed to load MediaPipe:', e);
                return false;
            }
        }

        // ============ Global State ============
        let poseLandmarker = null;
        let video = null;
        let canvas = null;
        let ctx = null;
        let currentScenario = 'labor';
        let isProcessing = false;
        let lastFrameTime = 0;
        let fps = 0;
        let frameCount = 0;
        let lastFpsUpdate = 0;

        // Body Detection State
        let bodyDetected = false;
        let lastBodyDetectedTime = 0;
        let noBodyWarningShown = false;
        const NO_BODY_TIMEOUT_MS = 3000; // Show warning after 3 seconds of no detection

        // Position Guidance Constants
        const VISIBILITY_THRESHOLD = 0.5; // Minimum visibility score to consider landmark "visible"
        const EDGE_MARGIN = 0.15; // 15% from edge is considered "too close to edge"

        // Analyze body position and return guidance
        function analyzeBodyPosition(landmarks) {
            if (!landmarks || landmarks.length === 0) return null;

            const guidance = [];

            // Key landmarks
            const nose = landmarks[0];
            const leftShoulder = landmarks[11];
            const rightShoulder = landmarks[12];
            const leftHip = landmarks[23];
            const rightHip = landmarks[24];

            // 1. Check if hips/belly are visible (important for labor scenarios)
            const hipsVisible = (leftHip && leftHip.visibility > VISIBILITY_THRESHOLD) ||
                (rightHip && rightHip.visibility > VISIBILITY_THRESHOLD);

            if (!hipsVisible) {
                // Check if body is in frame at all (shoulders visible)
                const shouldersVisible = (leftShoulder && leftShoulder.visibility > VISIBILITY_THRESHOLD) ||
                    (rightShoulder && rightShoulder.visibility > VISIBILITY_THRESHOLD);
                if (shouldersVisible) {
                    guidance.push({
                        arrow: '‚¨áÔ∏è',
                        text: '‡¶™‡ßá‡¶ü ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®',
                        subtext: '‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ ‡¶®‡¶ø‡¶ö‡ßá ‡¶ï‡¶∞‡ßÅ‡¶®',
                        priority: 2
                    });
                }
            }

            // 2. Check if shoulders are visible
            const shouldersVisible = (leftShoulder && leftShoulder.visibility > VISIBILITY_THRESHOLD) ||
                (rightShoulder && rightShoulder.visibility > VISIBILITY_THRESHOLD);
            if (!shouldersVisible && hipsVisible) {
                guidance.push({
                    arrow: '‚¨ÜÔ∏è',
                    text: '‡¶ï‡¶æ‡¶Å‡¶ß ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®',
                    subtext: '‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ ‡¶â‡¶™‡¶∞‡ßá ‡¶ï‡¶∞‡ßÅ‡¶®',
                    priority: 1
                });
            }

            // 3. Check horizontal position (is person at edge of frame?)
            if (nose && nose.visibility > VISIBILITY_THRESHOLD) {
                if (nose.x < EDGE_MARGIN) {
                    guidance.push({
                        arrow: '‚û°Ô∏è',
                        text: '‡¶°‡¶æ‡¶® ‡¶¶‡¶ø‡¶ï‡ßá ‡¶Ø‡¶æ‡¶®',
                        subtext: '‡¶¨‡¶æ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ ‡¶¨‡¶æ‡¶Æ‡ßá ‡¶ò‡ßã‡¶∞‡¶æ‡¶®',
                        priority: 3
                    });
                } else if (nose.x > (1 - EDGE_MARGIN)) {
                    guidance.push({
                        arrow: '‚¨ÖÔ∏è',
                        text: '‡¶¨‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶ï‡ßá ‡¶Ø‡¶æ‡¶®',
                        subtext: '‡¶¨‡¶æ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ ‡¶°‡¶æ‡¶®‡ßá ‡¶ò‡ßã‡¶∞‡¶æ‡¶®',
                        priority: 3
                    });
                }
            }

            // Return highest priority guidance
            if (guidance.length === 0) return null;
            guidance.sort((a, b) => a.priority - b.priority);
            return guidance[0];
        }

        // Show/hide position guidance
        function updatePositionGuidance(guidance) {
            const el = document.getElementById('positionGuidance');
            if (!guidance) {
                el.style.display = 'none';
                return;
            }

            document.getElementById('guidanceArrow').textContent = guidance.arrow;
            document.getElementById('guidanceText').textContent = guidance.text;
            document.getElementById('guidanceSubtext').textContent = guidance.subtext;
            el.style.display = 'block';
        }

        // ============ Scenario Data ============
        const scenarios = {
            labor: {
                title_bn: 'üë∂ ‡¶™‡ßç‡¶∞‡¶∏‡¶¨ ‡¶∏‡¶π‡¶æ‡¶Ø‡¶º‡¶§‡¶æ',
                title_en: 'Labor Assistance',
                color: '#E91E63',
                icon: 'üë∂',
                instructions: [
                    { step: 1, text_bn: '‡¶Ü‡¶™‡ßÅ, ‡¶ò‡¶æ‡¶¨‡¶°‡¶º‡¶æ‡¶¨‡ßá‡¶® ‡¶®‡¶æ‡•§ ‡¶Æ‡¶æ‡¶ï‡ßá ‡¶Ü‡¶∞‡¶æ‡¶Æ ‡¶ï‡¶∞‡ßá ‡¶∂‡ßã‡¶Ø‡¶º‡¶æ‡¶® - ‡¶¨‡¶æ‡¶Æ ‡¶ï‡¶æ‡¶§ ‡¶¨‡¶æ ‡¶è‡¶ï‡¶ü‡ßÅ ‡¶π‡ßá‡¶≤‡¶æ‡¶® ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶¨‡¶∏‡¶æ‡¶®‡•§', text_en: 'Position mother comfortably - left lateral or semi-reclined', priority: 'normal' },
                    { step: 2, text_bn: '‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®, ‡¶∏‡¶¨‡ßÅ‡¶ú ‡¶ú‡¶æ‡¶Ø‡¶º‡¶ó‡¶æ‡¶Ø‡¶º ‡¶ï‡ßã‡¶Æ‡¶∞ ‡¶è‡¶ï‡¶ü‡ßÅ ‡¶â‡¶Å‡¶ö‡ßÅ ‡¶∞‡¶æ‡¶ñ‡¶≤‡ßá ‡¶¨‡¶æ‡¶ö‡ßç‡¶ö‡¶æ ‡¶®‡¶æ‡¶Æ‡¶§‡ßá ‡¶∏‡ßÅ‡¶¨‡¶ø‡¶ß‡¶æ ‡¶π‡¶¨‡ßá‡•§', text_en: 'Elevate pelvis in green zone (15 degrees)', priority: 'normal' },
                    { step: 3, text_bn: '‚ö†Ô∏è ‡¶Æ‡¶æ‡¶•‡¶æ ‡¶¨‡ßá‡¶∞ ‡¶π‡¶≤‡ßá ‡¶Ü‡¶∏‡ßç‡¶§‡ßá ‡¶ï‡¶∞‡ßá ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶® ‡¶ó‡¶≤‡¶æ‡¶Ø‡¶º ‡¶®‡¶æ‡¶°‡¶º‡¶ø ‡¶™‡ßá‡¶Å‡¶ö‡¶æ‡¶®‡ßã ‡¶Ü‡¶õ‡ßá ‡¶ï‡¶ø ‡¶®‡¶æ‡•§', text_en: 'Check for cord around neck when head emerges', priority: 'critical' },
                    { step: 4, text_bn: '‡¶Ü‡¶™‡ßÅ, ‡¶§‡¶æ‡¶°‡¶º‡¶æ‡¶π‡ßÅ‡¶°‡¶º‡ßã ‡¶ï‡¶∞‡¶¨‡ßá‡¶® ‡¶®‡¶æ‡•§ ‡¶®‡¶æ‡¶°‡¶º‡¶ø ‡¶ï‡¶æ‡¶ü‡¶æ‡¶∞ ‡¶Ü‡¶ó‡ßá ‡ß©‡ß¶ ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®, ‡¶¨‡¶æ‡¶ö‡ßç‡¶ö‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶≠‡¶æ‡¶≤‡ßã‡•§', text_en: 'Wait 30 seconds before cutting cord', priority: 'warning', timer: 30 }
                ],
                landmarks: {
                    primary: [23, 24],  // Hips
                    secondary: [11, 12] // Shoulders
                },
                overlay: 'pelvis_guide'
            },
            bleeding: {
                title_bn: 'ü©∏ ‡¶∞‡¶ï‡ßç‡¶§‡¶™‡¶æ‡¶§ - ‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶è‡¶ï‡¶∏‡¶æ‡¶•‡ßá ‡¶∏‡¶æ‡¶Æ‡¶≤‡¶æ‡¶¨',
                title_en: 'Postpartum Hemorrhage',
                color: '#F44336',
                icon: 'ü©∏',
                instructions: [
                    { step: 1, text_bn: 'üö® ‡¶Ü‡¶™‡ßÅ, ‡¶è‡¶ñ‡¶®‡¶á ‡ßØ‡ßØ‡ßØ ‡¶ï‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®! ‡¶Ü‡¶Æ‡¶ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶Ü‡¶õ‡¶ø, ‡¶≠‡¶Ø‡¶º ‡¶™‡¶æ‡¶¨‡ßá‡¶® ‡¶®‡¶æ‡•§', text_en: 'Call 999 NOW - This is an emergency', priority: 'critical' },
                    { step: 2, text_bn: '‡¶è‡¶ñ‡¶® ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶ï‡¶•‡¶æ ‡¶∂‡ßÅ‡¶®‡ßÅ‡¶®: ‡¶®‡¶æ‡¶≠‡¶ø‡¶∞ ‡¶†‡¶ø‡¶ï ‡¶®‡¶ø‡¶ö‡ßá, ‡¶≤‡¶æ‡¶≤ ‡¶¨‡ßÉ‡¶§‡ßç‡¶§‡ßá, ‡¶¶‡ßÅ‡¶á ‡¶π‡¶æ‡¶§‡ßá ‡¶∂‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡ßá ‡¶ö‡¶æ‡¶™ ‡¶¶‡¶ø‡¶®‡•§', text_en: 'Uterine massage: Press firmly in red circle below navel', priority: 'critical' },
                    { step: 3, text_bn: '‡¶ö‡¶æ‡¶™ ‡¶¶‡¶ø‡¶§‡ßá ‡¶•‡¶æ‡¶ï‡ßÅ‡¶®, ‡¶ò‡¶°‡¶º‡¶ø‡¶∞ ‡¶ï‡¶æ‡¶Å‡¶ü‡¶æ‡¶∞ ‡¶¶‡¶ø‡¶ï‡ßá ‡¶ò‡ßÅ‡¶∞‡¶ø‡¶Ø‡¶º‡ßá ‡¶ò‡ßÅ‡¶∞‡¶ø‡¶Ø‡¶º‡ßá‡•§ ‡ßß‡ß´ ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü ‡¶ß‡¶∞‡ßá ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá, ‡¶Ü‡¶Æ‡¶ø ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶¶‡ßá‡¶ñ‡¶õ‡¶ø‡•§', text_en: 'Rotate clockwise for 15 minutes', priority: 'critical', timer: 900 },
                    { step: 4, text_bn: '‡¶Æ‡¶æ‡¶Ø‡¶º‡ßá‡¶∞ ‡¶™‡¶æ ‡¶è‡¶ï‡¶ü‡ßÅ ‡¶â‡¶Å‡¶ö‡ßÅ ‡¶ï‡¶∞‡ßá ‡¶∞‡¶æ‡¶ñ‡ßÅ‡¶®, ‡¶¨‡¶æ‡¶≤‡¶ø‡¶∂ ‡¶¶‡¶ø‡¶®‡•§ ‡¶è‡¶§‡ßá ‡¶∞‡¶ï‡ßç‡¶§‡¶ö‡¶æ‡¶™ ‡¶†‡¶ø‡¶ï ‡¶•‡¶æ‡¶ï‡¶¨‡ßá‡•§', text_en: 'Elevate legs - prevent shock', priority: 'warning' }
                ],
                landmarks: {
                    primary: [23, 24],
                    secondary: [0]
                },
                overlay: 'fundal_massage'
            },
            seizure: {
                title_bn: '‚ö° ‡¶ñ‡¶ø‡¶Å‡¶ö‡ßÅ‡¶®‡¶ø - ‡¶∂‡¶æ‡¶®‡ßç‡¶§ ‡¶•‡¶æ‡¶ï‡ßÅ‡¶®',
                title_en: 'Seizure / Eclampsia',
                color: '#FF9800',
                icon: '‚ö°',
                instructions: [
                    { step: 1, text_bn: 'üö® ‡¶Ü‡¶™‡ßÅ, ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡ßØ‡ßØ‡ßØ ‡¶ï‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®! ‡¶§‡¶æ‡¶∞‡¶™‡¶∞ ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶ï‡¶•‡¶æ ‡¶∂‡ßÅ‡¶®‡ßÅ‡¶®‡•§', text_en: 'Call 999 immediately', priority: 'critical' },
                    { step: 2, text_bn: '‡¶Æ‡¶æ‡¶ï‡ßá ‡¶Ü‡¶∏‡ßç‡¶§‡ßá ‡¶ï‡¶∞‡ßá ‡¶¨‡¶æ‡¶Æ ‡¶ï‡¶æ‡¶§‡ßá ‡¶ò‡ßã‡¶∞‡¶æ‡¶®‡•§ ‡¶§‡ßÄ‡¶∞‡ßá‡¶∞ ‡¶¶‡¶ø‡¶ï‡ßá ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®, ‡¶è‡¶≠‡¶æ‡¶¨‡ßá‡•§', text_en: 'Turn mother to LEFT side - follow arrow direction', priority: 'critical' },
                    { step: 3, text_bn: '‡¶Æ‡ßÅ‡¶ñ‡ßá ‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶¶‡ßá‡¶¨‡ßá‡¶® ‡¶®‡¶æ! ‡¶ú‡¶ø‡¶π‡ßç‡¶¨‡¶æ ‡¶ï‡¶æ‡¶Æ‡¶°‡¶º‡¶æ‡¶≤‡ßá‡¶ì ‡¶ö‡¶ø‡¶®‡ßç‡¶§‡¶æ ‡¶®‡¶æ‡¶á, ‡¶è‡¶ü‡¶æ ‡¶∏‡ßç‡¶¨‡¶æ‡¶≠‡¶æ‡¶¨‡¶ø‡¶ï‡•§', text_en: 'Nothing in mouth - tongue biting is normal', priority: 'warning' },
                    { step: 4, text_bn: '‡¶Æ‡¶æ‡¶•‡¶æ‡¶∞ ‡¶™‡¶æ‡¶∂‡ßá ‡¶•‡¶æ‡¶ï‡ßÅ‡¶®, ‡¶¨‡¶Æ‡¶ø ‡¶π‡¶≤‡ßá ‡¶Æ‡ßÅ‡¶ñ ‡¶™‡¶∞‡¶ø‡¶∑‡ßç‡¶ï‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶¶‡¶ø‡¶® ‡¶Ø‡ßá‡¶® ‡¶∂‡ßç‡¶¨‡¶æ‡¶∏ ‡¶®‡¶ø‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡•§', text_en: 'Keep airway clear - remove vomit if any', priority: 'critical' }
                ],
                landmarks: {
                    primary: [11, 23],
                    secondary: [12, 24]
                },
                overlay: 'recovery_position'
            },
            newborn: {
                title_bn: 'üë∂üíö ‡¶¨‡¶æ‡¶ö‡ßç‡¶ö‡¶æ‡¶ï‡ßá ‡¶¨‡¶æ‡¶Å‡¶ö‡¶æ‡¶®',
                title_en: 'Neonatal Resuscitation',
                color: '#4CAF50',
                icon: 'üë∂üíö',
                instructions: [
                    { step: 1, text_bn: '‡¶Ü‡¶™‡ßÅ, ‡¶¨‡¶æ‡¶ö‡ßç‡¶ö‡¶æ‡¶ï‡ßá ‡¶∂‡ßÅ‡¶ï‡¶®‡ßã ‡¶ï‡¶æ‡¶™‡¶°‡¶º ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶Ü‡¶∏‡ßç‡¶§‡ßá ‡¶Ü‡¶∏‡ßç‡¶§‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®, ‡¶™‡¶ø‡¶†‡ßá ‡¶π‡¶æ‡¶≤‡¶ï‡¶æ ‡¶•‡¶æ‡¶™‡¶°‡¶º ‡¶¶‡¶ø‡¶®‡•§', text_en: 'Dry baby with cloth - stimulate', priority: 'critical' },
                    { step: 2, text_bn: '‡¶¨‡¶æ‡¶ö‡ßç‡¶ö‡¶æ‡¶∞ ‡¶Æ‡¶æ‡¶•‡¶æ ‡¶è‡¶ï‡¶ü‡ßÅ ‡¶™‡ßá‡¶õ‡¶®‡ßá ‡¶π‡ßá‡¶≤‡¶æ‡¶®, ‡¶è‡¶§‡ßá ‡¶®‡¶æ‡¶ï-‡¶Æ‡ßÅ‡¶ñ ‡¶ñ‡ßÅ‡¶≤‡¶¨‡ßá, ‡¶∂‡ßç‡¶¨‡¶æ‡¶∏ ‡¶®‡¶ø‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡•§', text_en: 'Tilt head slightly back - open airway', priority: 'critical' },
                    { step: 3, text_bn: 'ü´Å ‡¶∂‡ßç‡¶¨‡¶æ‡¶∏ ‡¶®‡¶æ ‡¶®‡¶ø‡¶≤‡ßá: ‡¶¨‡¶æ‡¶ö‡ßç‡¶ö‡¶æ‡¶∞ ‡¶®‡¶æ‡¶ï-‡¶Æ‡ßÅ‡¶ñ ‡¶¢‡ßá‡¶ï‡ßá ‡ß´‡¶ü‡¶æ ‡¶õ‡ßã‡¶ü ‡¶õ‡ßã‡¶ü ‡¶´‡ßÅ‡¶Å ‡¶¶‡¶ø‡¶®‡•§', text_en: 'If not breathing: Give 5 rescue breaths', priority: 'critical' },
                    { step: 4, text_bn: 'üíì ‡¶¨‡ßÅ‡¶ï ‡¶®‡¶æ ‡¶®‡¶°‡¶º‡¶≤‡ßá: ‡¶¶‡ßÅ‡¶á ‡¶Ü‡¶ô‡ßÅ‡¶≤ ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶¨‡ßÅ‡¶ï‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶ù‡¶ñ‡¶æ‡¶®‡ßá ‡¶ö‡¶æ‡¶™ ‡¶¶‡¶ø‡¶®, ‡¶§‡¶æ‡¶≤‡ßá ‡¶§‡¶æ‡¶≤‡ßá‡•§', text_en: 'No heartbeat: Start chest compressions (100-120/min)', priority: 'critical', metronome: true }
                ],
                landmarks: {
                    primary: [11, 12],
                    secondary: [23, 24]
                },
                overlay: 'chest_compressions'
            }
        };

        // ============ Clinical Mode (Doctor) ============

        window.openClinicalMode = async function () {
            const modal = document.getElementById('clinicalModal');
            const content = document.getElementById('clinicalContent');
            modal.style.display = 'block';

            // Show loading
            content.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div class="loading-spinner" style="margin: 0 auto; border-top-color: #00BCD4;"></div>
                    <p style="margin-top: 15px; color: #aaa;">Generating Senior Clinical Insight...</p>
                </div>
            `;

            try {
                // Prepare context (Mock Vitals for Demo + Real Scenario)
                const vitals = {
                    "Scenario": currentScenario,
                    "Timestamp": new Date().toISOString(),
                    "Detected_Body": bodyDetected ? "Yes" : "No"
                };

                const response = await fetch('/api/ar-labor/clinical-analysis', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: "demo_patient_001",
                        current_vitals: vitals
                    })
                });

                const data = await response.json();

                // Render Report
                content.innerHTML = `
                    <div style="margin-bottom: 20px; border-left: 4px solid #00BCD4; padding-left: 15px;">
                        <h3 style="color: #00BCD4; font-size: 16px;">Clinical Summary</h3>
                        <p style="font-size: 14px; line-height: 1.5;">${data.clinical_summary || 'No summary available.'}</p>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #aaa; font-size: 12px; text-transform: uppercase; margin-bottom: 10px;">Potential Causality</h4>
                        <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; font-size: 14px;">
                            ${data.potential_causality || 'N/A'}
                        </div>
                    </div>

                    <!-- Differential Diagnosis -->
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #aaa; font-size: 12px; text-transform: uppercase; margin-bottom: 10px;">Differential Diagnosis</h4>
                        ${(data.differential_diagnoses || []).map(d => `
                            <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: bold; color: ${d.likelihood === 'High' ? '#F44336' : 'white'};">${d.condition_name}</div>
                                    <div style="font-size: 11px; opacity: 0.7;">${d.supporting_evidence?.join(', ')}</div>
                                </div>
                                <div style="font-size: 12px; background: rgba(0,0,0,0.3); padding: 4px 8px; border-radius: 4px;">${d.likelihood}</div>
                            </div>
                        `).join('')}
                    </div>

                    <!-- Interventions -->
                    <div>
                        <h4 style="color: #aaa; font-size: 12px; text-transform: uppercase; margin-bottom: 10px;">Recommended Interventions</h4>
                        ${(data.recommended_interventions || []).map(i => `
                            <div style="background: rgba(0, 188, 212, 0.1); border: 1px solid rgba(0, 188, 212, 0.3); padding: 12px; border-radius: 8px; margin-bottom: 8px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                    <strong style="color: #00BCD4;">${i.action}</strong>
                                    <span style="font-size: 11px; background: #00BCD4; color: black; padding: 2px 6px; border-radius: 4px;">${i.urgency}</span>
                                </div>
                                <div style="font-size: 12px; opacity: 0.8;">${i.rationale}</div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="margin-top: 15px; font-size: 10px; opacity: 0.5; text-align: center;">
                        Confidence Score: ${data.confidence_score} | ID: ${data.patient_id}
                    </div>
                `;

            } catch (e) {
                console.error(e);
                content.innerHTML = `
                    <div style="text-align: center; color: #F44336; padding: 30px;">
                        <h3>Failed to generate report</h3>
                        <p>${e.message}</p>
                    </div>
                `;
            }
        }

        // ============ Initialize System ============
        async function init() {
            video = document.getElementById('ar-video');
            canvas = document.getElementById('ar-canvas');
            ctx = canvas.getContext('2d');

            // Setup connectivity monitoring
            setupConnectivityMonitor();

            // Setup battery monitoring
            setupBatteryMonitor();

            // Load MediaPipe
            const loaded = await loadMediaPipe();
            if (!loaded) {
                document.getElementById('loadingOverlay').innerHTML = `
                    <p style="color: #F44336; font-size: 18px;">‚ùå AR ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º‡¶®‡¶ø</p>
                    <p style="margin-top: 10px;">‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶®‡ßá‡¶ü ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®</p>
                    <button onclick="location.reload()" style="margin-top: 20px; padding: 12px 25px; border: none; border-radius: 20px; background: #E91E63; color: white; cursor: pointer;">‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                `;
                return;
            }

            // Create pose landmarker
            try {
                const vision = await FilesetResolver.forVisionTasks(
                    "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/wasm"
                );

                poseLandmarker = await PoseLandmarker.createFromOptions(vision, {
                    baseOptions: {
                        modelAssetPath: "https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task",
                        delegate: "GPU"
                    },
                    runningMode: "VIDEO",
                    numPoses: 1
                });

                console.log('‚úÖ Pose Landmarker created');
            } catch (e) {
                console.error('‚ùå Failed to create Pose Landmarker:', e);
            }

            // Start camera
            await startCamera();

            // Hide loading overlay
            document.getElementById('loadingOverlay').style.display = 'none';

            // Load initial scenario
            selectScenario('labor');

            // Start processing loop
            requestAnimationFrame(processFrame);
        }

        // ============ Camera Setup ============
        // ============ Camera Setup ============
        async function startCamera() {
            let stream = null;

            try {
                // Attempt 1: Standard Mobile Config (Rear Camera + Audio)
                console.log("Attempting primary camera config...");
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: true
                });
            } catch (e1) {
                console.warn('Primary camera config failed:', e1);

                try {
                    // Attempt 2: Laptop/Basic Config (Any Camera + Audio)
                    console.log("Attempting fallback config 1 (Basic)...");
                    stream = await navigator.mediaDevices.getUserMedia({
                        video: true,
                        audio: true
                    });
                } catch (e2) {
                    console.warn('Fallback config 1 failed:', e2);

                    try {
                        // Attempt 3: Emergency Config (Video Only - No Audio)
                        // Sometimes audio permission blocks the whole thing
                        console.log("Attempting fallback config 2 (Video Only)...");
                        stream = await navigator.mediaDevices.getUserMedia({
                            video: true,
                            audio: false
                        });
                        alert("‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ: ‡¶Æ‡¶æ‡¶á‡¶ï‡ßç‡¶∞‡ßã‡¶´‡ßã‡¶® ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡¶õ‡ßá ‡¶®‡¶æ, ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§");
                    } catch (e3) {
                        console.error('All camera attempts failed:', e3);
                        // Detailed error for debugging
                        const errorDetails = `Name: ${e3.name}, Message: ${e3.message}`;
                        alert(`‚ö†Ô∏è ‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ!\n\n‡¶ï‡¶æ‡¶∞‡¶£: ${e3.name}\n\n‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§: ${e3.message}\n\n‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®:\n‡ßß. ‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞‡ßá ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ü‡¶õ‡ßá ‡¶ï‡¶ø‡¶®‡¶æ\n‡ß®. ‡¶Ö‡¶®‡ßç‡¶Ø ‡¶ï‡ßã‡¶®‡ßã ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶õ‡ßá ‡¶ï‡¶ø‡¶®‡¶æ`);
                        return;
                    }
                }
            }

            // Success handling
            try {
                // Separate video track for video element
                const videoStream = new MediaStream(stream.getVideoTracks());
                video.srcObject = videoStream;

                // Handle audio tracks if present
                const audioTracks = stream.getAudioTracks();
                if (audioTracks.length > 0) {
                    window.globalAudioStream = new MediaStream(audioTracks);
                }

                await new Promise(resolve => {
                    video.onloadedmetadata = () => {
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        resolve();
                    };
                });

                await video.play();
                console.log('‚úÖ Camera started successfully');
            } catch (setupError) {
                console.error('Error setting up video stream:', setupError);
                alert('‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶Æ ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶ö‡ßç‡¶õ‡ßá ‡¶®‡¶æ: ' + setupError.message);
            }
        }

        // ============ Frame Processing ============
        function processFrame(timestamp) {
            if (!poseLandmarker || !video.videoWidth) {
                requestAnimationFrame(processFrame);
                return;
            }

            // Calculate FPS
            frameCount++;
            if (timestamp - lastFpsUpdate > 1000) {
                fps = frameCount;
                frameCount = 0;
                lastFpsUpdate = timestamp;
                document.getElementById('fpsText').textContent = fps + ' FPS';
            }

            // Process pose
            const results = poseLandmarker.detectForVideo(video, timestamp);

            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Track body detection and update status
            const hasBody = results.landmarks && results.landmarks.length > 0;

            if (hasBody) {
                // Body detected
                bodyDetected = true;
                lastBodyDetectedTime = timestamp;
                noBodyWarningShown = false;

                // Update status badge - Green
                document.getElementById('arStatusBadge').style.background = 'rgba(76, 175, 80, 0.9)';
                document.getElementById('arStatusBadge').style.color = 'white';
                document.getElementById('arStatusIcon').textContent = '‚úÖ';
                document.getElementById('arStatusText').textContent = '‡¶∂‡¶∞‡ßÄ‡¶∞ ‡¶∏‡¶®‡¶æ‡¶ï‡ßç‡¶§ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá';

                // Hide warning
                document.getElementById('noBodyWarning').style.display = 'none';

                // Draw AR overlays
                drawAROverlay(results.landmarks[0], currentScenario);

                // Analyze position and show guidance if needed
                const guidance = analyzeBodyPosition(results.landmarks[0]);
                updatePositionGuidance(guidance);
            } else {
                // No body detected
                bodyDetected = false;

                // Check if we should show warning (after timeout)
                if (timestamp - lastBodyDetectedTime > NO_BODY_TIMEOUT_MS) {
                    if (!noBodyWarningShown) {
                        noBodyWarningShown = true;
                    }

                    // Update status badge - Red
                    document.getElementById('arStatusBadge').style.background = 'rgba(244, 67, 54, 0.9)';
                    document.getElementById('arStatusBadge').style.color = 'white';
                    document.getElementById('arStatusIcon').textContent = '‚ö†Ô∏è';
                    document.getElementById('arStatusText').textContent = '‡¶∂‡¶∞‡ßÄ‡¶∞ ‡¶¶‡ßá‡¶ñ‡¶æ ‡¶Ø‡¶æ‡¶ö‡ßç‡¶õ‡ßá ‡¶®‡¶æ';

                    // Show warning
                    document.getElementById('noBodyWarning').style.display = 'block';
                } else {
                    // Still scanning (within timeout)
                    document.getElementById('arStatusBadge').style.background = 'rgba(255, 193, 7, 0.9)';
                    document.getElementById('arStatusBadge').style.color = '#333';
                    document.getElementById('arStatusIcon').textContent = 'üîç';
                    document.getElementById('arStatusText').textContent = '‡¶∏‡ßç‡¶ï‡ßç‡¶Ø‡¶æ‡¶® ‡¶ï‡¶∞‡¶õ‡ßá...';
                }
            }

            requestAnimationFrame(processFrame);
        }

        // ============ AR Overlay Drawing ============
        function drawAROverlay(landmarks, scenario) {
            const config = scenarios[scenario];
            if (!config) return;

            ctx.save();

            switch (config.overlay) {
                case 'pelvis_guide':
                    drawPelvisGuide(landmarks, config.color);
                    break;
                case 'fundal_massage':
                    drawFundalMassageZone(landmarks, config.color);
                    break;
                case 'recovery_position':
                    drawRecoveryPositionArrow(landmarks, config.color);
                    break;
                case 'chest_compressions':
                    drawChestCompressionZone(landmarks, config.color);
                    break;
            }

            // Draw skeleton for reference
            drawSkeleton(landmarks);

            ctx.restore();
        }

        // Pelvis Guide for Labor
        function drawPelvisGuide(landmarks, color) {
            const hipL = landmarks[23];
            const hipR = landmarks[24];

            if (!hipL || !hipR) return;

            const centerX = ((hipL.x + hipR.x) / 2) * canvas.width;
            const centerY = ((hipL.y + hipR.y) / 2) * canvas.height;
            const radius = Math.abs(hipL.x - hipR.x) * canvas.width * 0.6;

            // Green zone for pelvic positioning
            ctx.beginPath();
            ctx.arc(centerX, centerY - radius * 0.3, radius, 0, Math.PI * 2);
            ctx.fillStyle = 'rgba(76, 175, 80, 0.3)';
            ctx.fill();
            ctx.strokeStyle = '#4CAF50';
            ctx.lineWidth = 3;
            ctx.stroke();

            // Label
            ctx.fillStyle = 'white';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('ACTION: Elevate Pelvis 15¬∞', centerX, centerY - radius - 20);
            ctx.font = '12px Arial';
            ctx.fillText('‚úì ‡¶∏‡¶¨‡ßÅ‡¶ú ‡¶ú‡ßã‡¶®', centerX, centerY - radius * 0.3);
        }

        // Fundal Massage Zone for PPH
        function drawFundalMassageZone(landmarks, color) {
            const hipL = landmarks[23];
            const hipR = landmarks[24];
            const shoulderL = landmarks[11];

            if (!hipL || !hipR) return;

            const centerX = ((hipL.x + hipR.x) / 2) * canvas.width;
            const centerY = ((hipL.y + hipR.y) / 2) * canvas.height - 50; // Above hips
            const radius = 60;

            // Pulsating red circle
            const pulse = Math.sin(Date.now() / 200) * 0.3 + 0.7;

            ctx.beginPath();
            ctx.arc(centerX, centerY, radius * pulse, 0, Math.PI * 2);
            ctx.fillStyle = `rgba(244, 67, 54, ${0.3 * pulse})`;
            ctx.fill();
            ctx.strokeStyle = '#F44336';
            ctx.lineWidth = 4;
            ctx.stroke();

            // Arrow showing massage direction (clockwise)
            drawRotationArrow(centerX, centerY, radius * 1.2, '#F44336');

            // Label
            ctx.fillStyle = 'white';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('ACTION: Press & Massage', centerX, centerY - radius - 20);
            ctx.font = '12px Arial';
            ctx.fillText('‡¶ò‡¶°‡¶º‡¶ø‡¶∞ ‡¶ï‡¶æ‡¶Å‡¶ü‡¶æ‡¶∞ ‡¶¶‡¶ø‡¶ï‡ßá ‡¶ö‡¶æ‡¶™‡ßÅ‡¶®', centerX, centerY + radius + 25);
        }

        // Recovery Position Arrow for Seizure
        function drawRecoveryPositionArrow(landmarks, color) {
            const shoulderL = landmarks[11];
            const shoulderR = landmarks[12];
            const hipL = landmarks[23];

            if (!shoulderL || !shoulderR || !hipL) return;

            const startX = shoulderR.x * canvas.width;
            const startY = shoulderR.y * canvas.height;
            const endX = shoulderL.x * canvas.width - 100;
            const endY = shoulderL.y * canvas.height;

            // Large arrow showing direction to roll
            ctx.beginPath();
            ctx.moveTo(startX, startY);
            ctx.lineTo(endX, endY);
            ctx.strokeStyle = '#FF9800';
            ctx.lineWidth = 8;
            ctx.stroke();

            // Arrow head
            const angle = Math.atan2(endY - startY, endX - startX);
            ctx.beginPath();
            ctx.moveTo(endX, endY);
            ctx.lineTo(endX - 30 * Math.cos(angle - 0.5), endY - 30 * Math.sin(angle - 0.5));
            ctx.lineTo(endX - 30 * Math.cos(angle + 0.5), endY - 30 * Math.sin(angle + 0.5));
            ctx.closePath();
            ctx.fillStyle = '#FF9800';
            ctx.fill();

            // Label
            ctx.fillStyle = 'white';
            ctx.font = 'bold 18px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('ACTION: Rotate to Left Side', (startX + endX) / 2, startY - 50);
            ctx.font = '14px Arial';
            ctx.fillText('‚Üê ‡¶¨‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶ï‡ßá ‡¶ò‡ßã‡¶∞‡¶æ‡¶®', (startX + endX) / 2, startY - 25);
        }

        // Chest Compression Zone for Newborn
        function drawChestCompressionZone(landmarks, color) {
            const shoulderL = landmarks[11];
            const shoulderR = landmarks[12];

            if (!shoulderL || !shoulderR) return;

            // Mother's chest area for skin-to-skin reference
            const centerX = ((shoulderL.x + shoulderR.x) / 2) * canvas.width;
            const centerY = ((shoulderL.y + shoulderR.y) / 2) * canvas.height + 80;

            // Heat map style overlay
            const gradient = ctx.createRadialGradient(centerX, centerY, 0, centerX, centerY, 100);
            gradient.addColorStop(0, 'rgba(76, 175, 80, 0.6)');
            gradient.addColorStop(0.5, 'rgba(76, 175, 80, 0.3)');
            gradient.addColorStop(1, 'rgba(76, 175, 80, 0)');

            ctx.fillStyle = gradient;
            ctx.fillRect(centerX - 100, centerY - 100, 200, 200);

            // Label
            ctx.fillStyle = 'white';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('‡¶§‡ßç‡¶¨‡¶ï‡ßá ‡¶§‡ßç‡¶¨‡¶ï ‡¶∏‡ßç‡¶™‡¶∞‡ßç‡¶∂', centerX, centerY);
            ctx.font = '12px Arial';
            ctx.fillText('Skin-to-skin', centerX, centerY + 18);
        }

        // Draw rotation arrow
        function drawRotationArrow(cx, cy, radius, color) {
            ctx.beginPath();
            ctx.arc(cx, cy, radius, -0.5, Math.PI * 1.5, false);
            ctx.strokeStyle = color;
            ctx.lineWidth = 3;
            ctx.stroke();

            // Arrow head at end of arc
            const angle = Math.PI * 1.5;
            const ax = cx + radius * Math.cos(angle);
            const ay = cy + radius * Math.sin(angle);

            ctx.beginPath();
            ctx.moveTo(ax, ay);
            ctx.lineTo(ax + 15, ay - 10);
            ctx.lineTo(ax + 5, ay + 10);
            ctx.closePath();
            ctx.fillStyle = color;
            ctx.fill();
        }

        // Draw skeleton
        function drawSkeleton(landmarks) {
            const connections = [
                [11, 12], [11, 13], [13, 15], [12, 14], [14, 16],
                [11, 23], [12, 24], [23, 24], [23, 25], [24, 26]
            ];

            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.lineWidth = 2;

            connections.forEach(([i, j]) => {
                if (landmarks[i] && landmarks[j]) {
                    ctx.beginPath();
                    ctx.moveTo(landmarks[i].x * canvas.width, landmarks[i].y * canvas.height);
                    ctx.lineTo(landmarks[j].x * canvas.width, landmarks[j].y * canvas.height);
                    ctx.stroke();
                }
            });

            // Draw key landmarks
            [11, 12, 23, 24].forEach(i => {
                if (landmarks[i]) {
                    ctx.beginPath();
                    ctx.arc(landmarks[i].x * canvas.width, landmarks[i].y * canvas.height, 6, 0, Math.PI * 2);
                    ctx.fillStyle = 'rgba(233, 30, 99, 0.8)';
                    ctx.fill();
                }
            });
        }

        // ============ Scenario Selection ============
        window.selectScenario = async function (scenario) {
            currentScenario = scenario;

            // Update buttons
            document.querySelectorAll('.scenario-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Handle specific button IDs or generic pattern
            let btnId = 'btn-' + scenario;
            if (scenario === 'ai_consult') {
                btnId = 'btn-ai';
            }

            const btn = document.getElementById(btnId);
            if (btn) {
                btn.classList.add('active');
            }

            // Update instructions
            await renderInstructions(scenario);

            // Stop any running timers/metronome
            stopTimer();
            stopMetronome();
        };

        // ============ AI Feature & Voice ============
        window.openAIModal = function () {
            document.getElementById('aiModal').style.display = 'flex';
            document.getElementById('aiInput').focus();
        };

        window.closeAIModal = function () {
            document.getElementById('aiModal').style.display = 'none';
        };

        window.startVoiceInput = function () {
            if (!('webkitSpeechRecognition' in window)) {
                alert('‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞‡ßá ‡¶≠‡¶Ø‡¶º‡ßá‡¶∏ ‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶®‡ßá‡¶á‡•§ ‡¶ï‡ßç‡¶∞‡ßã‡¶Æ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
                return;
            }

            const recognition = new webkitSpeechRecognition();
            recognition.lang = 'bn-BD'; // Bengali Bangladesh
            recognition.continuous = false;
            recognition.interimResults = false;

            const micBtn = document.getElementById('micBtn');
            micBtn.style.animation = 'pulse 1s infinite';
            micBtn.style.background = '#F44336'; // Red recording state

            recognition.onresult = function (event) {
                const text = event.results[0][0].transcript;
                document.getElementById('aiInput').value = text;
                submitAIQuery(); // Auto-submit
            };

            recognition.onerror = function (event) {
                console.error(event.error);
                micBtn.style.animation = 'none';
                micBtn.style.background = '#E91E63';

                // Aggressive Fallback: Switch to Server Mode for most errors
                const fallbackErrors = ['network', 'aborted', 'audio-capture', 'service-not-allowed'];

                if (fallbackErrors.includes(event.error)) {
                    console.log(`Switching to Server-Side Voice Fallback due to error: ${event.error}`);
                    recognition.stop();
                    // Small delay to ensure clean switch
                    setTimeout(() => startServerVoiceInput(), 100);
                    return;
                }

                let msg = '‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: ';
                if (event.error === 'not-allowed') msg = '‡¶Æ‡¶æ‡¶á‡¶ï‡ßç‡¶∞‡ßã‡¶´‡ßã‡¶® ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡ßá‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶®‡ßá‡¶á‡•§ ‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞ ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏‡ßá ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶¶‡¶ø‡¶®‡•§';
                else if (event.error === 'no-speech') msg = '‡¶ï‡ßã‡¶®‡ßã ‡¶ï‡¶•‡¶æ ‡¶∂‡ßã‡¶®‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§';
                else msg = '‡¶ï‡¶•‡¶æ ‡¶¨‡ßÅ‡¶ù‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶ø‡¶®‡¶ø (' + event.error + ')‡•§';

                alert(msg);
            };

            recognition.onend = function () {
                // Only reset if not switching to fallback
                if (micBtn.dataset.mode !== 'server') {
                    micBtn.style.animation = 'none';
                    micBtn.style.background = '#E91E63';
                }
            };

            recognition.start();
        };

        // ============ Fallback: Server-Side Recording (Exact Midwife Pattern) ============
        let arMediaRecorder;
        let arAudioChunks = [];
        let arRecording = false;

        window.startServerVoiceInput = async function () {
            const micBtn = document.getElementById('micBtn');

            if (!arRecording) {
                // Start recording
                await startARRecording(micBtn);
            } else {
                // Stop recording
                stopARRecording(micBtn);
            }
        };

        async function startARRecording(micBtn) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                arMediaRecorder = new MediaRecorder(stream);
                arAudioChunks = [];

                arMediaRecorder.ondataavailable = event => {
                    arAudioChunks.push(event.data);
                };

                arMediaRecorder.onstop = async () => {
                    // EXACT Midwife pattern: audio/wav type
                    const audioBlob = new Blob(arAudioChunks, { type: 'audio/wav' });
                    await processARVoiceAudio(audioBlob);
                };

                arMediaRecorder.start();
                arRecording = true;
                micBtn.style.background = 'linear-gradient(135deg, #f44336, #c62828)';
                micBtn.innerHTML = '‚èπÔ∏è';
            } catch (error) {
                alert('‡¶Æ‡¶æ‡¶á‡¶ï‡ßç‡¶∞‡ßã‡¶´‡ßã‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡ßç‡¶∏‡ßá‡¶∏ ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶õ‡¶ø ‡¶®‡¶æ: ' + error.message);
            }
        }

        function stopARRecording(micBtn) {
            if (arMediaRecorder && arMediaRecorder.state === 'recording') {
                arMediaRecorder.stop();
                arMediaRecorder.stream.getTracks().forEach(track => track.stop());
            }
            arRecording = false;
            micBtn.style.background = '#E91E63';
            micBtn.innerHTML = '‚è≥';
        }

        async function processARVoiceAudio(audioBlob) {
            const micBtn = document.getElementById('micBtn');
            try {
                const formData = new FormData();
                // EXACT Midwife pattern: field name 'file', extension '.wav'
                formData.append('file', audioBlob, 'ar_voice_input.wav');

                const transcribeResponse = await fetch('/api/voice/transcribe', {
                    method: 'POST',
                    body: formData
                });
                const transcribeData = await transcribeResponse.json();

                if (transcribeData.success && transcribeData.transcription) {
                    document.getElementById('aiInput').value = transcribeData.transcription;
                    submitAIQuery();
                } else {
                    alert('‚ùå ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: ' + (transcribeData.error || '‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡ßç‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡¶∂‡¶® ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•'));
                }
            } catch (error) {
                alert('‚ùå ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: ' + error.message);
            } finally {
                micBtn.innerHTML = 'üé§';
            }
        }


        // ============ Hospital & Doctor Data ============
        let nearbyHospitalData = null;
        let userLocation = null;

        // ============ Personalization & Profile ============
        const mockPatientProfile = {
            id: "P-102",
            name: "Fatema Begum",
            age: 26,
            trimester: 3,
            blood_group: "B+",
            risk_level: "High (Prev. Hemorrhage)",
            last_checkup: "2025-11-20"
        };

        async function fetchNearbyHospitalData(emergencyType = 'HEMORRHAGE') {
            if (nearbyHospitalData) return nearbyHospitalData;

            return new Promise((resolve) => {
                if (!navigator.geolocation) {
                    console.warn("Geolocation not supported");
                    resolve(null);
                    return;
                }

                navigator.geolocation.getCurrentPosition(async (position) => {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    try {
                        const response = await fetch('/api/midwife/emergency/activate', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                user_id: 'ar_user_' + Date.now(),
                                trigger_source: 'ar_dashboard',
                                detected_emergency: emergencyType,
                                red_flags: [emergencyType === 'bleeding' ? 'hemorrhage' : (emergencyType === 'seizure' ? 'eclampsia' : 'hemorrhage')],
                                patient_location: userLocation,
                                patient_profile: mockPatientProfile
                            })
                        });

                        const data = await response.json();
                        if (data.success) {
                            nearbyHospitalData = data.emergency;
                            resolve(nearbyHospitalData);
                        } else {
                            console.error("API Error Response:", data);
                            resolve(null);
                        }
                    } catch (e) {
                        console.error("Error fetching hospital data:", e);
                        resolve(null);
                    }
                }, (err) => {
                    console.warn("Geolocation error:", err);
                    resolve(null);
                });
            });
        }

        window.submitAIQuery = async function () {
            const query = document.getElementById('aiInput').value;
            if (!query) return;

            const btn = document.querySelector('button[onclick="submitAIQuery()"]');
            const originalText = btn.innerText;
            btn.innerText = "‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®...";
            btn.disabled = true;

            try {
                const response = await fetch('/api/ar-labor/consult', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: query,
                        patient_profile: mockPatientProfile
                    })
                });

                const data = await response.json();

                if (data.success) {
                    closeAIModal();
                    // Inject the new scenario into the registry
                    scenarios['ai_consult'] = data.scenario;
                    selectScenario('ai_consult');

                    // Auto-Speak Response
                    setTimeout(() => {
                        const intro = data.scenario.title_bn;
                        const firstStep = data.scenario.instructions[0]?.text_bn || "";
                        speak(intro + "‡•§ " + firstStep);
                    }, 500);

                } else {
                    alert('‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§, ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
                }
            } catch (e) {
                console.error(e);
                alert('‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶®‡ßá‡¶ü ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        };

        // ============ Render Instructions ============
        async function renderInstructions(scenario) {
            const config = scenarios[scenario];
            const panel = document.getElementById('instructionsPanel');

            // Trigger hospital data fetch if it's an emergency scenario
            const isEmergency = ['bleeding', 'seizure', 'newborn', 'ai_consult'].includes(scenario);
            if (isEmergency && !nearbyHospitalData) {
                await fetchNearbyHospitalData(scenario);
            }

            let html = `
                <div class="instruction-header">
                    <span class="icon">${config.icon}</span>
                    <div>
                        <div class="title">${config.title_bn}</div>
                        <div class="subtitle">${config.title_en}</div>
                    </div>
                </div>
            `;

            // Hospital Card (Live Data)
            if (isEmergency && nearbyHospitalData) {
                html += `
                    <div style="background: rgba(244, 67, 54, 0.15); border: 1px solid #F44336; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                            <div>
                                <strong style="color: #F44336; font-size: 14px;">üè• ‡¶®‡¶ø‡¶ï‡¶ü‡¶∏‡ßç‡¶• ‡¶π‡¶æ‡¶∏‡¶™‡¶æ‡¶§‡¶æ‡¶≤:</strong>
                                <div style="font-size: 16px; font-weight: bold; margin-top: 5px;">${nearbyHospitalData.nearest_hospital}</div>
                                <div style="font-size: 12px; opacity: 0.8; margin-top: 2px;">üìç ${nearbyHospitalData.hospital_distance_km} ‡¶ï‡¶ø‡¶Æ‡¶ø ‡¶¶‡ßÇ‡¶∞‡ßá | ‚è±Ô∏è ${nearbyHospitalData.estimated_response_time}</div>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 5px;">
                                <a href="tel:${nearbyHospitalData.hospital_phone}" style="background: #4CAF50; color: white; padding: 8px 15px; border-radius: 15px; text-decoration: none; font-size: 14px; font-weight: bold; text-align: center;">üìû ‡¶ï‡¶≤</a>
                                <a href="https://www.google.com/maps/dir/?api=1&destination=${nearbyHospitalData.hospital_lat},${nearbyHospitalData.hospital_lng}" target="_blank" style="background: #2196F3; color: white; padding: 8px 15px; border-radius: 15px; text-decoration: none; font-size: 14px; font-weight: bold; text-align: center;">üó∫Ô∏è ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶™</a>
                            </div>
                        </div>

                        ${nearbyHospitalData.emergency_unit ? `
                        <div style="background: rgba(255, 255, 255, 0.1); padding: 12px; border-radius: 10px; margin-bottom: 5px; border-left: 4px solid #4CAF50;">
                            <strong style="font-size: 12px; color: #4CAF50; display: block; margin-bottom: 2px;">üè• ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶Ø‡¶æ‡¶® (Entry):</strong>
                            <div style="font-size: 15px; font-weight: bold; color: white;">${nearbyHospitalData.emergency_unit}</div>
                        </div>
                        ` : ''}
                        
                        ${nearbyHospitalData.available_doctors && nearbyHospitalData.available_doctors.length > 0 ? `
                        <div style="border-top: 1px solid rgba(255,255,255,0.1); pt-10; margin-top: 10px; padding-top: 10px;">
                            <strong style="font-size: 12px; opacity: 0.7;">üë®‚Äç‚öïÔ∏è ‡¶¶‡¶æ‡ßü‡¶ø‡¶§‡ßç‡¶¨‡¶∞‡¶§ ‡¶∏‡ßç‡¶™‡ßá‡¶∂‡¶æ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü:</strong>
                            ${nearbyHospitalData.available_doctors.slice(0, 2).map(doc => `
                                <div style="font-size: 13px; margin-top: 5px; display: flex; justify-content: space-between;">
                                    <span>${doc.name} (${doc.role})</span>
                                    <span style="color: #4CAF50;">‚óè ${doc.available}</span>
                                </div>
                            `).join('')}
                        </div>
                        ` : ''}
                    </div>
                `;
            }

            // Personalization Badge
            if (nearbyHospitalData && mockPatientProfile) {
                html += `
                    <div style="background: linear-gradient(90deg, #9C27B0, #E91E63); color: white; padding: 5px 15px; border-radius: 15px; font-size: 11px; font-weight: bold; margin-bottom: 15px; display: inline-block; box-shadow: 0 2px 10px rgba(233, 30, 99, 0.3);">
                        ‚ú® ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§‡¶ø‡¶ó‡¶§‡¶ï‡ßÉ‡¶§ ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡ßá‡¶∂‡¶®‡¶æ: ${mockPatientProfile.name} (${mockPatientProfile.blood_group})
                    </div>
                `;
            }

            config.instructions.forEach(inst => {
                const priorityClass = inst.priority === 'critical' ? 'critical' : inst.priority === 'warning' ? 'warning' : '';

                html += `
                    <div class="instruction-step ${priorityClass}">
                        <div class="step-number">${inst.step}</div>
                        <div class="step-content">
                            <div class="step-bn">${inst.text_bn}</div>
                            <div class="step-en">${inst.text_en}</div>
                        </div>
                        ${inst.timer ? `<button class="speak-btn" onclick="startTimer(${inst.timer})">‚è±Ô∏è</button>` : ''}
                        ${inst.metronome ? `<button class="speak-btn" onclick="startMetronome()">üíì</button>` : ''}
                        <button class="speak-btn" onclick="speak('${inst.text_bn.replace(/'/g, "\\'")}')">üîä</button>
                    </div>
                `;
            });

            panel.innerHTML = html;
        }

        // ============ Timer Functions ============
        let timerInterval = null;

        window.startTimer = function (seconds) {
            const overlay = document.getElementById('timerOverlay');
            const display = document.getElementById('timerDisplay');

            let remaining = seconds;
            display.textContent = remaining;
            overlay.style.display = 'block';

            timerInterval = setInterval(() => {
                remaining--;
                display.textContent = remaining;

                if (remaining <= 0) {
                    stopTimer();
                    speak('‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶∂‡ßá‡¶∑!');
                }
            }, 1000);
        };

        window.stopTimer = function () {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            document.getElementById('timerOverlay').style.display = 'none';
        };

        // ============ Metronome for CPR ============
        let metronomeInterval = null;
        let compressionCount = 0;

        window.startMetronome = function () {
            const metronome = document.getElementById('metronome');
            const circle = document.getElementById('metronomeCircle');
            const countDisplay = document.getElementById('metronomeCount');

            metronome.style.display = 'block';
            compressionCount = 0;

            // 110 BPM = ~545ms per beat
            metronomeInterval = setInterval(() => {
                compressionCount++;
                countDisplay.textContent = compressionCount;

                circle.classList.add('beat');
                setTimeout(() => circle.classList.remove('beat'), 200);

                // Audio beep
                playBeep();

                // Reset count at 30
                if (compressionCount >= 30) {
                    compressionCount = 0;
                    speak('‡ß®‡¶ü‡¶ø ‡¶∂‡ßç‡¶¨‡¶æ‡¶∏ ‡¶¶‡¶ø‡¶®');
                }
            }, 545);
        };

        window.stopMetronome = function () {
            if (metronomeInterval) {
                clearInterval(metronomeInterval);
                metronomeInterval = null;
            }
            document.getElementById('metronome').style.display = 'none';
        };

        // Audio beep for metronome
        function playBeep() {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(800, audioCtx.currentTime);
                oscillator.connect(audioCtx.destination);
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.05);
            } catch (e) { }
        }

        // ============ Speech ============
        window.speak = async function (text) {
            try {
                // Cancel any ongoing speech
                if (window.currentAudio) {
                    window.currentAudio.pause();
                    window.currentAudio = null;
                }

                const response = await fetch('/api/voice/speak', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text, language: 'bn' })
                });

                if (response.ok) {
                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    window.currentAudio = new Audio(audioUrl);
                    await window.currentAudio.play();
                } else {
                    console.error('Backend TTS failed, falling back to client-side');
                    fallbackSpeak(text);
                }
            } catch (e) {
                console.error('TTS Error:', e);
                fallbackSpeak(text);
            }
        };

        function fallbackSpeak(text) {
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'bn-BD';
                utterance.rate = 0.9;
                speechSynthesis.speak(utterance);
            }
        }

        // ============ Connectivity Monitor ============
        function setupConnectivityMonitor() {
            const updateStatus = () => {
                const el = document.getElementById('connectionStatus');
                const text = document.getElementById('connectionText');
                if (navigator.onLine) {
                    el.className = 'status-item online';
                    text.textContent = '‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶®';
                } else {
                    el.className = 'status-item offline';
                    text.textContent = '‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶®';
                }
            };

            window.addEventListener('online', updateStatus);
            window.addEventListener('offline', updateStatus);
            updateStatus();
        }

        // ============ Battery Monitor ============
        async function setupBatteryMonitor() {
            if ('getBattery' in navigator) {
                try {
                    const battery = await navigator.getBattery();
                    const update = () => {
                        const percent = Math.round(battery.level * 100);
                        document.getElementById('batteryText').textContent = percent + '%';
                        document.getElementById('batteryStatus').style.color =
                            percent < 20 ? '#F44336' : percent < 50 ? '#FF9800' : '#4CAF50';
                    };
                    battery.addEventListener('levelchange', update);
                    update();
                } catch (e) { }
            }
        }

        // ============ Initialize ============
        init();
    </script>

    <!-- Register Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/static/ar-emergency-sw.js')
                .then(reg => console.log('‚úÖ Service Worker registered'))
                .catch(err => console.log('Service Worker registration failed:', err));
        }
    </script>
</body>

</html>