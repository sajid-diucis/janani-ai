<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Janani AI - Live Coaching Demo</title>
    <!-- MediaPipe -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    
    <style>
        body { margin: 0; background: #0f172a; color: white; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        
        .container { display: flex; height: 100vh; }
        
        /* Video Area */
        .video-container { flex: 2; position: relative; display: flex; align-items: center; justify-content: center; background: black; }
        video { position: absolute; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        canvas { position: absolute; width: 100%; height: 100%; transform: scaleX(-1); z-index: 10; }
        
        /* Controls & Feedback */
        .controls { flex: 1; background: #1e293b; padding: 30px; display: flex; flex-direction: column; border-left: 1px solid #334155; }
        
        h1 { margin-top: 0; color: #60a5fa; font-size: 1.8rem; }
        .status-badge { display: inline-block; padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; background: #ef4444; color: white; margin-bottom: 20px; }
        .status-badge.connected { background: #22c55e; }
        
        .debug-box { background: #000; border: 1px solid #334155; padding: 15px; font-family: monospace; height: 150px; overflow-y: auto; margin-bottom: 20px; color: #00ff00; font-size: 0.9rem; }
        
        .step-card { background: #334155; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .step-title { font-size: 0.9rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; }
        .step-content { font-size: 1.5rem; font-weight: bold; margin-top: 5px; color: white; }
        
        .action-btn { background: #2563eb; color: white; border: none; padding: 15px; border-radius: 8px; font-size: 1.1rem; cursor: pointer; transition: 0.2s; font-weight: bold; width: 100%; }
        .action-btn:hover { background: #1d4ed8; }
        .action-btn:disabled { background: #64748b; cursor: not-allowed; }

        .audio-wave { height: 50px; display: flex; align-items: center; justify-content: center; gap: 5px; margin-top: auto; }
        .bar { width: 5px; height: 10px; background: #60a5fa; animation: wave 1s infinite ease-in-out; }
        @keyframes wave { 0%, 100% { height: 10px; } 50% { height: 30px; } }
        
    </style>
</head>
<body>

<div class="container">
    <div class="video-container">
        <video id="input_video"></video>
        <canvas id="output_canvas"></canvas>
        
        <!-- Overlay Feedback -->
        <div id="ar-overlay" style="position: absolute; top: 20px; left: 20px; background: rgba(0,0,0,0.7); padding: 10px 20px; border-radius: 10px; z-index: 20; display: none;">
            <div style="font-size: 1.2rem; font-weight: bold;" id="ar-text">Analyzing...</div>
        </div>
    </div>
    
    <div class="controls">
        <h1>Live AI Coach</h1>
        <div id="connection-status" class="status-badge">Disconnected</div>
        
        <div class="step-card">
            <div class="step-title">Current Protocol</div>
            <div class="step-content">Step 2: Uterine Massage</div>
        </div>
        
        <div style="margin-bottom: 10px; font-weight: bold; color: #94a3b8;">AI Vision (Debug):</div>
        <div class="debug-box" id="debug-log">
            > System initialized...
            > Waiting for camera...
        </div>
        
        <button class="action-btn" id="start-btn" onclick="startSession()">â–¶ Start Coaching</button>
        
        <div class="audio-wave" id="audio-visualizer" style="opacity: 0;">
            <div class="bar" style="animation-delay: 0.1s"></div>
            <div class="bar" style="animation-delay: 0.2s"></div>
            <div class="bar" style="animation-delay: 0.3s"></div>
            <div class="bar" style="animation-delay: 0.4s"></div>
            <div class="bar" style="animation-delay: 0.5s"></div>
        </div>
    </div>
</div>

<script>
    const videoElement = document.getElementById('input_video');
    const canvasElement = document.getElementById('output_canvas');
    const canvasCtx = canvasElement.getContext('2d');
    const debugLog = document.getElementById('debug-log');
    let socket = null;
    let audioQueue = [];
    let isPlayingAudio = false;
    let lastLandmarks = null;

    // --- MediaPipe Setup ---
    function onResults(results) {
        canvasCtx.save();
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
        canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
        
        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            const landmarks = results.multiHandLandmarks[0];
            lastLandmarks = landmarks;
            
            // Draw
            drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 5});
            drawLandmarks(canvasCtx, landmarks, {color: '#FF0000', lineWidth: 2});
            
            // Send to Backend
            if (socket && socket.readyState === WebSocket.OPEN) {
                sendData(landmarks);
            }
        }
        canvasCtx.restore();
    }

    const hands = new Hands({locateFile: (file) => {
        return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
    }});
    
    hands.setOptions({
        maxNumHands: 1,
        modelComplexity: 1,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
    });
    
    hands.onResults(onResults);

    // --- WebSocket & Logic ---
    function startSession() {
        document.getElementById('start-btn').disabled = true;
        document.getElementById('start-btn').innerText = "Running...";
        
        // Start Camera
        const camera = new Camera(videoElement, {
            onFrame: async () => {
                await hands.send({image: videoElement});
            },
            width: 1280,
            height: 720
        });
        camera.start();
        
        // Connect WS
        connectWebSocket();
    }

    function connectWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        socket = new WebSocket(`${protocol}//${window.location.host}/ws/coaching/user_123`);
        
        socket.onopen = () => {
            document.getElementById('connection-status').innerText = "Connected";
            document.getElementById('connection-status').classList.add("connected");
            log("WebSocket Connected");
        };
        
        socket.onmessage = async (event) => {
            if (event.data instanceof Blob) {
                // Binary Audio Data
                const arrayBuffer = await event.data.arrayBuffer();
                queueAudio(arrayBuffer);
            } else {
                // JSON Control Data
                try {
                    const msg = JSON.parse(event.data);
                    handleControlMessage(msg);
                } catch (e) {
                    if (event.data === "END_AUDIO") {
                        // End of stream marker
                    }
                }
            }
        };
        
        socket.onclose = () => {
            document.getElementById('connection-status').innerText = "Disconnected";
            document.getElementById('connection-status').classList.remove("connected");
            log("WebSocket Disconnected");
        };
    }

    // Throttled Send
    let lastSend = 0;
    function sendData(landmarks) {
        const now = Date.now();
        if (now - lastSend > 100) { // 100ms cap
            socket.send(JSON.stringify({
                landmarks: landmarks,
                voice_text: "" // Placeholder for voice input
            }));
            lastSend = now;
        }
    }

    function handleControlMessage(msg) {
        if (msg.type === "debug") {
            log(`ðŸ‘€ ${msg.visual_desc}`);
            // Update AR Overlay
            const overlay = document.getElementById('ar-overlay');
            const text = document.getElementById('ar-text');
            overlay.style.display = 'block';
            text.innerText = msg.visual_desc;
        } else if (msg.type === "advice") {
            log(`ðŸ¤– AI: "${msg.text}" [${msg.tone}]`);
        }
    }

    // --- Audio Playback ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    function queueAudio(arrayBuffer) {
        audioCtx.decodeAudioData(arrayBuffer, (buffer) => {
            audioQueue.push(buffer);
            playNext();
        });
    }

    function playNext() {
        if (isPlayingAudio || audioQueue.length === 0) return;
        
        isPlayingAudio = true;
        document.getElementById('audio-visualizer').style.opacity = 1;
        
        const source = audioCtx.createBufferSource();
        source.buffer = audioQueue.shift();
        source.connect(audioCtx.destination);
        source.onended = () => {
            isPlayingAudio = false;
            if (audioQueue.length === 0) {
                 document.getElementById('audio-visualizer').style.opacity = 0;
            }
            playNext();
        };
        source.start(0);
    }

    function log(msg) {
        const line = document.createElement('div');
        line.innerText = `> ${msg}`;
        debugLog.prepend(line);
    }

    // Resize canvas to match video
    videoElement.onloadedmetadata = () => {
        canvasElement.width = videoElement.videoWidth;
        canvasElement.height = videoElement.videoHeight;
    };
</script>
</body>
</html>
